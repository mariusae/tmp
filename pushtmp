#!/usr/bin/env python3
"""
pushtmp - Mirror a directory to the mariusae/tmp GitHub repository.

This tool clones the repository to a temporary location, copies the specified
directory as a new top-level subdirectory, commits, and pushes.
"""

import argparse
import os
import shutil
import subprocess
import sys
import tempfile
from datetime import datetime
from pathlib import Path

REPO_URL = "git@github.com:mariusae/tmp.git"


def run(cmd: list[str], cwd: str | None = None, check: bool = True) -> subprocess.CompletedProcess:
    """Run a command and return the result."""
    result = subprocess.run(cmd, cwd=cwd, capture_output=True, text=True)
    if check and result.returncode != 0:
        print(f"Error running: {' '.join(cmd)}", file=sys.stderr)
        print(result.stderr, file=sys.stderr)
        sys.exit(1)
    return result


def main():
    parser = argparse.ArgumentParser(
        description="Mirror a directory to the mariusae/tmp GitHub repository.",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Push current directory with auto-generated name and timestamp message
  %(prog)s

  # Push with a custom commit message
  %(prog)s -m 'benchmark results'

  # Push a specific directory with a custom name
  %(prog)s /path/to/dir -n project -m 'preliminary version'
""",
    )
    parser.add_argument(
        "directory",
        nargs="?",
        default=".",
        help="Directory to mirror (default: current directory)",
    )
    parser.add_argument(
        "-n",
        "--name",
        dest="target_name",
        help="Name for the target subdirectory (default: basename of source directory)",
    )
    parser.add_argument(
        "-m",
        "--message",
        dest="commit_message",
        help="Commit message (default: timestamp)",
    )
    args = parser.parse_args()

    # Resolve source directory
    source_dir = Path(args.directory).resolve()
    if not source_dir.is_dir():
        print(f"Error: '{source_dir}' is not a directory", file=sys.stderr)
        sys.exit(1)

    # Determine target name
    target_name = args.target_name or source_dir.name
    if not target_name or target_name in (".", ".."):
        print(f"Error: Invalid target name '{target_name}'", file=sys.stderr)
        sys.exit(1)

    # Generate commit message
    commit_message = args.commit_message or datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # Create temporary directory for the clone
    with tempfile.TemporaryDirectory() as tmpdir:
        repo_dir = Path(tmpdir) / "repo"

        print(f"Cloning {REPO_URL}...")
        run(["git", "clone", "--depth=1", REPO_URL, str(repo_dir)])

        # Check if target already exists
        target_path = repo_dir / target_name
        if target_path.exists():
            print(f"Error: '{target_name}' already exists in the repository", file=sys.stderr)
            sys.exit(1)

        # Copy the directory
        print(f"Copying '{source_dir}' to '{target_name}'...")
        shutil.copytree(source_dir, target_path)

        # Stage, commit, and push
        print("Committing...")
        run(["git", "add", target_name], cwd=str(repo_dir))
        run(["git", "commit", "-m", commit_message], cwd=str(repo_dir))

        print("Pushing...")
        run(["git", "push"], cwd=str(repo_dir))

        print(f"Successfully pushed '{target_name}' to {REPO_URL}")


if __name__ == "__main__":
    main()
